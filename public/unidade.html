<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Detalhes da Unidade</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="site-header">
        <div class="header-container">
            <div class="header-content">
                <button onclick="voltar()" class="voltar-btn">Voltar</button>
                <h1>Computadores da Unidade</h1>
            </div>
        </div>
    </header>

    <main>
        <h2 id="nome-unidade" style="margin-bottom: 20px; color: #004080;"></h2>
        <div id="lista-computadores"></div>
        
        <div class="chart-container">
            <canvas id="unidade-chart"></canvas>
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const unidadeId = urlParams.get('id');

        if (!unidadeId) {
            alert('Unidade inválida.');
            window.location.href = 'index.html';
        }

        async function carregarComputadores() {
            try {
                const resUnidade = await fetch(`/api/unidades`);
                const unidades = await resUnidade.json();
                const unidade = unidades.find(u => u.id == unidadeId);

                if (!unidade) {
                    alert('Unidade não encontrada.');
                    window.location.href = 'index.html';
                    return;
                }

                document.getElementById('nome-unidade').innerText = unidade.nome;

                const res = await fetch(`/api/unidades/${unidadeId}/computadores`);
                const computadores = await res.json();

                const container = document.getElementById('lista-computadores');
                container.innerHTML = '';

                if (computadores.length === 0) {
                    container.innerHTML = '<p>Nenhum computador cadastrado.</p>';
                } else {
                    computadores.forEach(comp => {
                        const div = document.createElement('div');
                        div.className = `computador-card ${comp.otimizado ? 'otimizado' : 'pendente'}`;
                        div.innerHTML = `
                            <div class="info">
                                <strong>Setor:</strong> ${comp.setor}<br>
                                <strong>Patrimônio:</strong> ${comp.patrimonio}<br>
                                <strong>Quantidade:</strong> ${comp.quantidade}<br>
                                <span class="status">${comp.otimizado ? 'Otimizado' : 'Pendente'}</span>
                            </div>
                            <div class="actions">
                                <label>
                                    <input type="checkbox" onchange="alterarStatusOtimizado(${comp.id}, this.checked)" ${comp.otimizado ? 'checked' : ''}> Otimizado
                                </label>
                                <button onclick="editarComputador(${comp.id}, '${comp.setor}', '${comp.patrimonio}', ${comp.quantidade})" class="btn editar-btn">Editar</button>
                                <button onclick="excluirComputador(${comp.id})" class="btn excluir-btn">Excluir</button>
                                <button onclick="abrirComentario(${comp.id}, \`${comp.comentario || ''}\`)" class="btn relatorio-btn">Comentário</button>
                            </div>
                        `;
                        container.appendChild(div);
                    });
                }

                // Chama a função para criar o gráfico após carregar os cards
                criarGraficoUnidade(computadores);

            } catch (error) {
                console.error('Erro ao carregar computadores:', error);
            }
        }

        // NOVA FUNÇÃO: Cria o gráfico de otimização
        function criarGraficoUnidade(computadores) {
            // Conta quantos computadores estão otimizados e pendentes
            const otimizados = computadores.filter(c => c.otimizado).length;
            const pendentes = computadores.filter(c => !c.otimizado).length;

            const ctx = document.getElementById('unidade-chart').getContext('2d');
            
            // Se já existe um gráfico, destrói para evitar sobreposição
            if (window.unidadeChart) {
                window.unidadeChart.destroy();
            }

            window.unidadeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Otimizados', 'Pendentes'],
                    datasets: [{
                        data: [otimizados, pendentes],
                        backgroundColor: ['#28a745', '#dc3545'], // Cores correspondentes aos cards
                        borderColor: ['#ffffff', '#ffffff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Status dos Computadores por Otimização',
                            font: {
                                size: 18,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        // Funções de editar, excluir, alterar status e abrir comentário (mantidas do seu código)
        async function alterarStatusOtimizado(compId, otimizado) {
            try {
                const response = await fetch(`/api/computadores/${compId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ otimizado: otimizado ? 1 : 0 })
                });
                if (response.ok) {
                    carregarComputadores();
                } else {
                    alert('Erro ao alterar status.');
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function excluirComputador(compId) {
            if (!confirm('Tem certeza que deseja excluir?')) return;
            try {
                const response = await fetch(`/api/computadores/${compId}`, { method: 'DELETE' });
                if (response.ok) {
                    carregarComputadores();
                } else {
                    alert('Erro ao excluir.');
                }
            } catch (error) {
                console.error(error);
            }
        }

        function editarComputador(compId, setor, patrimonio, quantidade) {
            const container = document.getElementById('lista-computadores');
            container.innerHTML = `
                <h3 style="color: #004080;">Editar Computador</h3>
                <div class="formulario-container">
                    <label>Setor: <input type="text" id="input-setor-${compId}" value="${setor}"></label><br>
                    <label>Patrimônio: <input type="text" id="input-patrimonio-${compId}" value="${patrimonio}"></label><br>
                    <label>Quantidade: <input type="number" id="input-quantidade-${compId}" value="${quantidade}" min="1"></label><br>
                    <button onclick="salvarComputador(${compId})" class="btn salvar-btn">Salvar</button>
                    <button onclick="carregarComputadores()" class="btn cancelar-btn">Cancelar</button>
                </div>
            `;
        }

        async function salvarComputador(compId) {
            const setor = document.getElementById(`input-setor-${compId}`).value.trim();
            const patrimonio = document.getElementById(`input-patrimonio-${compId}`).value.trim();
            const quantidade = parseInt(document.getElementById(`input-quantidade-${compId}`).value.trim(), 10);

            if (!setor || !patrimonio || quantidade < 1) {
                alert('Preencha todos os campos corretamente.');
                return;
            }

            try {
                const response = await fetch(`/api/computadores/${compId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setor, patrimonio, quantidade })
                });
                if (response.ok) {
                    carregarComputadores();
                } else {
                    alert('Erro ao salvar.');
                }
            } catch (error) {
                console.error(error);
            }
        }

        function abrirComentario(compId, comentarioAtual) {
            const container = document.getElementById('lista-computadores');
            container.innerHTML = `
                <h3 style="color: #004080; margin-bottom: 12px;">Comentário para o computador ID ${compId}</h3>
                <textarea id="comentario-textarea" rows="6" style="width: 100%; padding: 10px; font-size: 1rem; border: 2px solid #004080; border-radius: 8px;">${comentarioAtual}</textarea>
                <div style="margin-top: 16px;">
                    <button class="btn salvar-btn" onclick="salvarComentario(${compId})">Salvar Comentário</button>
                    <button class="btn cancelar-btn" onclick="carregarComputadores()">Cancelar</button>
                </div>
            `;
        }

        async function salvarComentario(compId) {
            const comentario = document.getElementById('comentario-textarea').value.trim();

            try {
                const response = await fetch(`/api/computadores/${compId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comentario })
                });
                if (response.ok) {
                    alert('Comentário salvo com sucesso!');
                    carregarComputadores();
                } else {
                    alert('Erro ao salvar comentário.');
                }
            } catch (error) {
                console.error(error);
                alert('Erro ao salvar comentário.');
            }
        }

        function voltar() {
            window.location.href = 'index.html';
        }

        carregarComputadores();
    </script>
</body>
</html>